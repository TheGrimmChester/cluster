configure

load /opt/vyatta/etc/config.boot.default

#reset dns forwarding all

set interfaces ethernet eth0 address '192.168.1.3/24'
set interfaces ethernet eth1 address '192.168.3.3/24'
set interfaces loopback lo

# Wireguard
set interfaces wireguard wg0 address '192.168.28.2/24'
set interfaces wireguard wg0 description 'VPN-to-wg0'
set interfaces wireguard wg0 peer to-wg0 allowed-ips '192.168.28.0/24'
set interfaces wireguard wg0 peer to-wg0 allowed-ips '192.168.1.0/24'
set interfaces wireguard wg0 peer to-wg0 address '217.160.98.197'
set interfaces wireguard wg0 peer to-wg0 port '51820'
set interfaces wireguard wg0 peer to-wg0 persistent-keepalive '25'
set interfaces wireguard wg0 peer to-wg0 public-key 'TlgI8NmJapU8UGiL+0flKwsGyoNxSwfZLICABjFRpiA='
set interfaces wireguard wg0 peer to-wg0 preshared-key 'Ltl9wD03h8lzJOxaMpWuN36XUf8yk5Y8Gp+t2yEEWcY='
set interfaces wireguard wg0 port '51820'
set interfaces wireguard wg0 private-key '2HDix/p8Xjo/liZWqd6Fi5ImOBA1j4Bo8L6bP8iKEmc='

set protocols static route 192.168.1.0/24 interface wg0

##Firewall
#For the WireGuard traffic to pass through the WAN interface, you must create a firewall exception.
set firewall ipv4 name OUTSIDE_LOCAL rule 10 action accept
set firewall ipv4 name OUTSIDE_LOCAL rule 10 description 'Allow established/related'
set firewall ipv4 name OUTSIDE_LOCAL rule 10 state established enable
set firewall ipv4 name OUTSIDE_LOCAL rule 10 state related enable
set firewall ipv4 name OUTSIDE_LOCAL rule 20 action accept
set firewall ipv4 name OUTSIDE_LOCAL rule 20 description WireGuard_IN
set firewall ipv4 name OUTSIDE_LOCAL rule 20 destination port 51820
set firewall ipv4 name OUTSIDE_LOCAL rule 20 log enable
set firewall ipv4 name OUTSIDE_LOCAL rule 20 protocol udp
set firewall ipv4 name OUTSIDE_LOCAL rule 20 source

#You should also ensure that the OUTSIDE_LOCAL firewall group is applied to the WAN interface and a direction (local).
#set interfaces ethernet eth0 firewall local name 'OUTSIDE-LOCAL'
###marche pas


# Configure DHCP for LAN
set service dhcp-server shared-network-name LAN subnet 192.168.1.0/24 range 0 start 192.168.1.10
set service dhcp-server shared-network-name LAN subnet 192.168.1.0/24 range 0 stop 192.168.1.100
set service dhcp-server shared-network-name LAN subnet 192.168.1.0/24 default-router 192.168.1.3
set service dhcp-server shared-network-name LAN subnet '192.168.1.0/24' name-server '192.168.1.3'
set service dhcp-server shared-network-name LAN subnet '192.168.1.0/24' domain-name 'home.arpa'

# Delete the DHCP server configuration
delete service dhcp-server

# Setup DNS forwarder
set service dns forwarding system
set service dns forwarding cache-size 0
set service dns forwarding listen-address 192.168.1.3
set service dns forwarding name-server 192.168.1.200
#set service dns forwarding dhcp eth0
set service dns forwarding domain clouded.fr server 192.168.1.200
set service dns forwarding name-server 1.1.1.1
set service dns forwarding allow-from '192.168.1.0/24'
set service dns forwarding allow-from '192.168.28.0/24'
set service dns forwarding no-serve-rfc1918

# dont know
set protocols static route 0.0.0.0/0 next-hop '192.168.1.254' distance '1'

set load-balancing wan flush-connections

set load-balancing wan interface-health eth0 failure-count '2'
set load-balancing wan interface-health eth0 nexthop '192.168.1.254'
set load-balancing wan interface-health eth0 success-count '1'
set load-balancing wan interface-health eth0 test 1 resp-time '1'
set load-balancing wan interface-health eth0 test 1 target '8.8.4.4'
set load-balancing wan interface-health eth0 test 1 ttl-limit '1'
set load-balancing wan interface-health eth0 test 1 type 'ping'

set load-balancing wan interface-health eth1 failure-count '2'
set load-balancing wan interface-health eth1 nexthop '192.168.3.1'
set load-balancing wan interface-health eth1 success-count '1'
set load-balancing wan interface-health eth1 test 1 resp-time '5'
set load-balancing wan interface-health eth1 test 1 target '8.8.8.8'
set load-balancing wan interface-health eth1 test 1 ttl-limit '1'
set load-balancing wan interface-health eth1 test 1 type 'ping'

# Route par d√©faut pour le load balancer
set load-balancing wan rule 1 inbound-interface 'eth0'
set load-balancing wan rule 1 interface eth0

# Bascule la gateway de sortie sur eth1 si eth0 est KO
set load-balancing wan rule 2 failover
set load-balancing wan rule 2 inbound-interface 'eth0'
set load-balancing wan rule 2 interface eth1 weight '1'
set load-balancing wan rule 2 interface eth0 weight '10'

set protocols static route 8.8.4.4/32 next-hop 192.168.1.254
set protocols static route 8.8.8.8/32 next-hop 192.168.3.1

set service ntp allow-client address '0.0.0.0/0'
set service ntp allow-client address '::/0'
set service ntp server time1.vyos.net
set service ntp server time2.vyos.net
set service ntp server time3.vyos.net

set service ssh port '22'

set system config-management commit-revisions '100'

set system conntrack modules ftp
set system conntrack modules h323
set system conntrack modules nfs
set system conntrack modules pptp
set system conntrack modules sip
set system conntrack modules sqlnet
set system conntrack modules tftp

set system console device ttyS0 speed '115200'
set system domain-name 'home.arpa'
#set system domain-search domain clouded.fr
set system domain-search domain home.arpa
set system host-name 'vyos'
set system ipv6 disable-forwarding

#set system login user vyos authentication encrypted-password '$6$QxPS.uk6mfo$9QBSo8u1FkH16gMyAVhus6fU3LOzvLR9Z9.82m3tiHFAxTtIkhaZSWssSgzt4v4dGAL8rhVQxTg0oAG9/q11h/'
#set system login user vyos authentication plaintext-password ''

set system name-server '192.168.1.200'
set system name-server '1.1.1.1'
set system syslog global facility all level 'info'
set system syslog global facility local7 level 'debug'

commit
save
exit
